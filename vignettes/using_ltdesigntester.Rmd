---
title: "Using `ltdesigntester`"
author: "David L Miller"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

`ltdesigntester` is an R package to test basic survey designs and highlight potential issues with using simple estimators (such as Horvitz-Thompson-like estimators; henceforth HT) when animal distribution changes in space.

The package takes a given setup of animal density, design and sighting paramters and generates multiple possible results for a given design. From there a series of different possible models are fitted to the data and relevant statistics recorded.

# Requirements

The following things are required to build a simulation:

  - study area shapefile: defining the area in which the study takes place.
  - density surface: giving "true" the distribution of the animals in the study area.
  - population size: "true" number of animals in the study area.
  - survey design shapefile: the lines to be surveyed, already segmented. Additional list of correspondence of transects to segments is required.
  - detection function definition: describing the detectability and truncation for the survey.
  * stratification scheme: for the HT estimator.

# A simple example



```{r load-pkgs}
suppressPackageStartupMessages(library(DSsim))
suppressPackageStartupMessages(library(dsm))
suppressPackageStartupMessages(library(Distance))
suppressPackageStartupMessages(library(ltdesigntester))
```

```{r setopts}
true_N <- 500

n_grid_x <- 300
n_grid_y <- 100
density.surface <- expand.grid(x = seq(0, 3, len=n_grid_x),
                               y = seq(0, 1, len=n_grid_y))
# setup the prediction grid
cell_side_x <- 0.05
cell_side_y <- 0.05/3
pred_dat1 <- expand.grid(x = seq(0, 3, by=cell_side_x),
                         y = seq(0, 1, by=cell_side_y))
# set the grid cell size
pred_dat1$off.set <- cell_side_x*cell_side_y
# rotation matrix
R <- matrix(c(cos(pi/4), sin(pi/4), -sin(pi/4), cos(pi/4)),2,2)
# rotate predictions
pred_dat1[,c("xr","yr")] <- t(R %*% t(pred_dat1[,c("x","y")]))


# setup detection function
df <- list(key        = "hr",
           scale      = 0.025,
           shape      = 3,
           truncation = 0.05)
```

```{r}
# setup densities
density.surface$density <- 5*(density.surface$x/3)

# stratification schemes
stratification <- c(1, 2)

# transect definitions
transects <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2,
               2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4,
               4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5,
               6, 6, 6, 6, 6, 6, 6, 6, 6)

```

```{r build-sim}
# build simulation setup
ss <- build_sim(system.file("shapes/manyzigzags", package="ltdesigntester"),
                dsurf=density.surface,
                n_grid_x=n_grid_x, n_grid_y=n_grid_y,
                n_pop=true_N, df=df,
                region=paste0(system.file("shapes/region2/", package="ltdesigntester"),"data"))
```

```{r check-setup, fig.width=6, fig.height=6}
check_sim_setup(ss)
```


```{r sim-it}
big_res <- do_sim(10, ss, pred_dat1, stratification,
                  transect_id=transects)
```